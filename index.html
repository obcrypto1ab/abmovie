<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamVault - Legal Movie Library</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary-color)',
                        accent: 'var(--accent-color)',
                        surface: 'var(--surface-color)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- ImageKit SDK (Standard UNPKG) -->
    <script src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --accent-color: #8b5cf6;
            --surface-color: #1f2937;
        }
        body { font-family: 'Inter', sans-serif; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-dark {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Loader */
        .loader {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="fixed w-full z-50 glass-dark">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex-shrink-0 cursor-pointer" onclick="router.navigate('home')">
                    <span id="nav-logo" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                        StreamVault
                    </span>
                </div>
                
                <!-- Search -->
                <div class="hidden md:block flex-1 max-w-md mx-8" id="search-container">
                    <div class="relative">
                        <input type="text" id="global-search" placeholder="Search legal movies..." 
                            class="w-full bg-gray-800 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary border border-gray-700">
                    </div>
                </div>

                <!-- Right Menu -->
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-700 transition">
                        ðŸŒ™
                    </button>
                    <div id="auth-section">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app" class="flex-grow pt-20 px-4 max-w-7xl mx-auto w-full">
        <!-- Views injected here -->
    </main>

    <!-- Footer -->
    <footer id="footer" class="border-t border-gray-800 mt-12 py-8 text-center text-gray-500 text-sm hidden">
        <p>&copy; <span id="footer-year"></span> <span id="footer-site-name">StreamVault</span>. All content is legally licensed or public domain.</p>
    </footer>

    <!-- Modals -->
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm fade-in">
        <div class="bg-gray-800 rounded-xl p-8 max-w-sm w-full shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-center">Welcome Back</h2>
            <form id="login-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email" required class="w-full bg-gray-700 rounded p-3 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                <input type="password" id="password" placeholder="Password" required class="w-full bg-gray-700 rounded p-3 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                <button type="submit" class="w-full bg-primary hover:opacity-90 text-white font-bold py-3 rounded transition">Sign In</button>
                <p id="auth-error" class="text-red-400 text-sm text-center hidden"></p>
            </form>
            <button onclick="ui.toggleModal('auth-modal', false)" class="mt-4 text-gray-400 text-sm w-full text-center hover:text-white">Close</button>
        </div>
    </div>

    <!-- Movie Details Modal -->
    <div id="movie-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md fade-in">
        <div class="bg-gray-900 rounded-2xl max-w-4xl w-full mx-4 overflow-hidden shadow-2xl border border-gray-700 flex flex-col md:flex-row max-h-[90vh]">
            <div id="movie-modal-poster" class="w-full md:w-1/3 bg-cover bg-center h-64 md:h-auto"></div>
            <div class="p-8 w-full md:w-2/3 flex flex-col overflow-y-auto">
                <div class="flex justify-between items-start">
                    <h2 id="movie-modal-title" class="text-3xl font-bold text-white mb-2"></h2>
                    <button onclick="ui.toggleModal('movie-modal', false)" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="flex items-center gap-3 text-sm text-gray-400 mb-4">
                    <span id="movie-modal-year" class="bg-gray-800 px-2 py-1 rounded"></span>
                    <span id="movie-modal-rating" class="text-yellow-400 font-bold"></span>
                </div>
                <p id="movie-modal-desc" class="text-gray-300 leading-relaxed mb-6"></p>
                
                <div class="mt-auto space-y-3">
                    <a id="movie-modal-watch" href="#" target="_blank" class="block w-full text-center bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-500/30">
                        â–¶ Watch Now
                    </a>
                    <a id="movie-modal-download" href="#" target="_blank" class="hidden block w-full text-center border border-gray-600 hover:bg-gray-800 text-white py-3 rounded-lg transition">
                        â¬‡ Download (Legal)
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Overlay -->
    <div id="admin-panel" class="fixed inset-0 z-[55] hidden bg-gray-900 overflow-y-auto">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">Admin Dashboard</h1>
                <button onclick="router.navigate('home')" class="bg-gray-800 px-4 py-2 rounded text-white hover:bg-gray-700">Exit Admin</button>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-4 border-b border-gray-700 mb-6">
                <button onclick="admin.switchTab('movies')" class="admin-tab px-4 py-2 text-white border-b-2 border-primary" data-tab="movies">Movies</button>
                <button onclick="admin.switchTab('categories')" class="admin-tab px-4 py-2 text-gray-400 hover:text-white" data-tab="categories">Categories</button>
                <button onclick="admin.switchTab('settings')" class="admin-tab px-4 py-2 text-gray-400 hover:text-white" data-tab="settings">Settings</button>
            </div>

            <!-- Tab Content: Movies -->
            <div id="tab-movies" class="admin-content">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-semibold">Library Content</h2>
                    <button onclick="admin.openMovieEditor()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">+ Add Movie</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-800 text-gray-200 uppercase">
                            <tr>
                                <th class="p-3">Title</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Year</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-movies-list" class="divide-y divide-gray-800">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Content: Categories -->
            <div id="tab-categories" class="admin-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-semibold">Manage Categories</h2>
                    <button onclick="admin.addCategory()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">+ Add Category</button>
                </div>
                <div id="admin-categories-list" class="space-y-2"></div>
            </div>

            <!-- Tab Content: Settings -->
            <div id="tab-settings" class="admin-content hidden space-y-6">
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">General Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="set-siteName" placeholder="Site Name" class="bg-gray-700 p-2 rounded text-white w-full">
                        <input type="text" id="set-heroTitle" placeholder="Hero Title" class="bg-gray-700 p-2 rounded text-white w-full">
                        <input type="text" id="set-heroSubtitle" placeholder="Hero Subtitle" class="bg-gray-700 p-2 rounded text-white w-full">
                    </div>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Toggles</h3>
                    <div class="flex gap-4 flex-wrap" id="set-toggles">
                        <!-- Checkboxes injected -->
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-lg font-bold text-white mb-4">Theme</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label>Primary Color</label>
                            <input type="color" id="set-primaryColor" class="w-full h-10 rounded">
                        </div>
                    </div>
                </div>
                
                <button onclick="admin.saveSettings()" class="bg-primary hover:opacity-90 text-white px-6 py-2 rounded font-bold">Save All Settings</button>
            </div>
        </div>
    </div>

    <!-- Movie Editor Modal (Admin) -->
    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-90 backdrop-blur">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4" id="editor-title">Edit Movie</h2>
            <form id="movie-form" class="space-y-3">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="edit-title" placeholder="Movie Title" required class="bg-gray-700 p-2 rounded text-white w-full">
                    <input type="number" id="edit-year" placeholder="Year" required class="bg-gray-700 p-2 rounded text-white w-full">
                </div>
                <textarea id="edit-desc" placeholder="Description" rows="3" class="bg-gray-700 p-2 rounded text-white w-full"></textarea>
                
                <!-- Poster Upload -->
                <div class="border border-dashed border-gray-600 p-4 rounded text-center">
                    <p class="text-sm text-gray-400 mb-2">Poster Image (JPG, PNG, WEBP - Max 10MB)</p>
                    <input type="file" id="edit-poster-file" accept="image/png, image/jpeg, image/webp" class="text-sm text-gray-400">
                    <input type="hidden" id="edit-posterUrl">
                    <div id="upload-progress-container" class="w-full bg-gray-700 h-2 mt-2 rounded hidden">
                        <div id="upload-progress-bar" class="bg-green-500 h-2 rounded transition-all duration-300" style="width:0%"></div>
                    </div>
                    <p id="upload-status-text" class="text-xs text-gray-400 mt-1"></p>
                </div>

                <input type="url" id="edit-watchUrl" placeholder="Watch URL (Legal Stream)" required class="bg-gray-700 p-2 rounded text-white w-full">
                <input type="url" id="edit-downloadUrl" placeholder="Download URL (Optional - Legal Only)" class="bg-gray-700 p-2 rounded text-white w-full">
                
                <div class="grid grid-cols-2 gap-4">
                    <select id="edit-status" class="bg-gray-700 p-2 rounded text-white">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                    </select>
                    <input type="number" id="edit-trendingScore" placeholder="Trending Score (0-100)" class="bg-gray-700 p-2 rounded text-white">
                </div>

                <!-- Categories -->
                <div class="bg-gray-700 p-3 rounded">
                    <p class="text-sm text-gray-300 mb-2">Categories</p>
                    <div id="edit-categories" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="ui.toggleModal('editor-modal', false)" class="text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" id="btn-save-movie" class="bg-primary px-4 py-2 rounded text-white">Save Movie</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 z-[70] border border-gray-700">
        <span id="toast-msg"></span>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyABgaLI-JUjeB45cwW0De6iGyy8io72Opg",
            authDomain: "abmovie-d4826.firebaseapp.com",
            projectId: "abmovie-d4826",
            storageBucket: "abmovie-d4826.firebasestorage.app",
            messagingSenderId: "187818385326",
            appId: "1:187818385326:web:4bdffca6053e08033c323f"
        };

        const ADMIN_EMAIL = "bristyxom@gmail.com";
        // ImageKit Constants
        const IK_PUBLIC_KEY = "public_Wt+RjZXgdesltZmb4M/5SO8ncZk=";
        const IK_URL_ENDPOINT = "https://ik.imagekit.io/4maqtfplt";
        const IK_AUTH_ENDPOINT = "/api/imagekit-auth";

        // --- 2. INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 3. STATE MANAGEMENT ---
        const state = {
            user: null,
            isAdmin: false,
            settings: null,
            categories: [],
            movies: [],
            filter: ''
        };

        // --- 4. UTILS ---
        const utils = {
            sanitize: (str) => {
                const temp = document.createElement('div');
                temp.textContent = str || '';
                return temp.innerHTML;
            },
            showToast: (msg, type = 'info') => {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                toast.classList.remove('translate-y-20');
                if(type === 'error') toast.classList.add('text-red-400');
                else toast.classList.remove('text-red-400');
                
                setTimeout(() => {
                    toast.classList.add('translate-y-20');
                }, 3000);
            },
            toggleDarkMode: () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            },
            slugify: (text) => {
                return text.toString().toLowerCase()
                    .replace(/\s+/g, '-')           // Replace spaces with -
                    .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                    .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                    .replace(/^-+/, '')             // Trim - from start of text
                    .replace(/-+$/, '');            // Trim - from end of text
            }
        };

        // Initialize Theme
        if (localStorage.theme === 'light') document.documentElement.classList.remove('dark');
        else document.documentElement.classList.add('dark');

        // --- 5. DATA LAYER ---
        const data = {
            init: () => {
                onSnapshot(doc(db, "settings", "global"), (doc) => {
                    if (doc.exists()) {
                        state.settings = doc.data();
                        ui.applySettings();
                        if(!document.getElementById('admin-panel').classList.contains('hidden')) admin.renderSettingsForm();
                    } else if(state.isAdmin) data.seedSettings();
                });

                onSnapshot(query(collection(db, "categories"), orderBy("order")), (snapshot) => {
                    state.categories = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    ui.renderHome();
                    if(state.isAdmin) admin.renderCategoriesList();
                });

                onSnapshot(query(collection(db, "movies"), orderBy("createdAt", "desc")), (snapshot) => {
                    state.movies = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    ui.renderHome();
                    if(state.isAdmin) admin.renderMoviesList();
                });
            },
            seedSettings: async () => {
                await setDoc(doc(db, "settings", "global"), {
                    siteName: "StreamVault",
                    heroTitle: "Cinematic Excellence",
                    heroSubtitle: "Curated legal content for the connoisseur.",
                    theme: { primaryColor: "#3b82f6" },
                    toggles: { showTrending: true, showFooter: true, showSearch: true }
                });
            }
        };

        // --- 6. UI RENDERER ---
        const ui = {
            toggleModal: (id, show) => {
                const el = document.getElementById(id);
                if (show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            },
            applySettings: () => {
                if (!state.settings) return;
                document.documentElement.style.setProperty('--primary-color', state.settings.theme.primaryColor || '#3b82f6');
                document.getElementById('nav-logo').innerText = state.settings.siteName;
                document.getElementById('footer-site-name').innerText = state.settings.siteName;
                document.getElementById('footer-year').innerText = new Date().getFullYear();
                
                state.settings.toggles.showFooter 
                    ? document.getElementById('footer').classList.remove('hidden') 
                    : document.getElementById('footer').classList.add('hidden');

                state.settings.toggles.showSearch 
                    ? document.getElementById('search-container').classList.remove('hidden') 
                    : document.getElementById('search-container').classList.add('hidden');
                
                ui.renderHome();
            },
            renderHome: () => {
                const app = document.getElementById('app');
                const published = state.movies.filter(m => m.status === 'published');
                
                if (!state.settings) return; 

                let html = `
                    <div class="relative w-full h-[60vh] rounded-2xl overflow-hidden mb-12 shadow-2xl group">
                        <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/40 to-transparent z-10"></div>
                        <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" 
                             style="background-image: url('${published.length ? published[0].posterUrl : ''}')">
                        </div>
                        <div class="absolute bottom-0 left-0 p-8 z-20 max-w-2xl">
                            <h1 class="text-4xl md:text-6xl font-bold text-white mb-4 drop-shadow-lg">${state.settings.heroTitle}</h1>
                            <p class="text-lg text-gray-200 mb-6 drop-shadow-md">${state.settings.heroSubtitle}</p>
                        </div>
                    </div>
                `;

                const renderRow = (title, movies) => {
                    if (movies.length === 0) return '';
                    return `
                        <div class="mb-12">
                            <h2 class="text-2xl font-bold mb-6 pl-2 border-l-4 border-primary text-white">${title}</h2>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                                ${movies.map(m => ui.components.movieCard(m)).join('')}
                            </div>
                        </div>
                    `;
                };

                let displayMovies = published;
                if (state.filter) {
                    displayMovies = published.filter(m => m.title.toLowerCase().includes(state.filter.toLowerCase()));
                    html += renderRow(`Search Results`, displayMovies);
                } else {
                    if (state.settings.toggles.showTrending) {
                        const trending = [...published].sort((a,b) => (b.trendingScore || 0) - (a.trendingScore || 0)).slice(0, 5);
                        html += renderRow("Trending Now", trending);
                    }

                    state.categories.forEach(cat => {
                        if (cat.enabled) {
                            const catMovies = published.filter(m => m.categorySlugs && m.categorySlugs.includes(cat.slug));
                            html += renderRow(cat.name, catMovies);
                        }
                    });

                    html += renderRow("Recently Added", published.slice(0, 10));
                }

                app.innerHTML = html;
            },
            components: {
                movieCard: (movie) => {
                    return `
                        <div class="relative group cursor-pointer" onclick="ui.openMovie('${movie.id}')">
                            <div class="aspect-[2/3] rounded-xl overflow-hidden shadow-lg bg-gray-800 relative">
                                <img src="${movie.posterUrl}" alt="${utils.sanitize(movie.title)}" loading="lazy" 
                                    class="w-full h-full object-cover transition duration-300 group-hover:scale-110 group-hover:opacity-60">
                                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                                    <div class="bg-primary rounded-full p-3 shadow-lg transform scale-0 group-hover:scale-100 transition duration-300 delay-75">
                                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h3 class="font-semibold text-white truncate">${utils.sanitize(movie.title)}</h3>
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>${movie.year}</span>
                                    <span>${movie.categorySlugs ? movie.categorySlugs[0] || '' : ''}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },
            openMovie: (id) => {
                const m = state.movies.find(x => x.id === id);
                if(!m) return;
                
                document.getElementById('movie-modal-title').innerText = m.title;
                document.getElementById('movie-modal-desc').innerText = m.description;
                document.getElementById('movie-modal-year').innerText = m.year;
                document.getElementById('movie-modal-rating').innerText = `â˜… ${m.rating || 'N/A'}`;
                document.getElementById('movie-modal-poster').style.backgroundImage = `url('${m.posterUrl}')`;
                
                const watchBtn = document.getElementById('movie-modal-watch');
                watchBtn.href = m.watchUrl;
                
                const dlBtn = document.getElementById('movie-modal-download');
                if (m.downloadUrl && state.settings.toggles.allowDownloads !== false) { 
                     dlBtn.href = m.downloadUrl;
                     dlBtn.classList.remove('hidden');
                } else {
                    dlBtn.classList.add('hidden');
                }

                ui.toggleModal('movie-modal', true);
            }
        };

        // --- 7. ADMIN CONTROLLER ---
        const admin = { 
            editMovie: (id) => {
  admin.openMovieEditor(id);
},
            check: () => {
                if (!state.isAdmin) return;
                document.getElementById('admin-panel').classList.remove('hidden');
                admin.renderMoviesList();
            },
            switchTab: (tabName) => {
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                document.querySelectorAll('.admin-tab').forEach(el => {
                    el.classList.remove('border-b-2', 'border-primary', 'text-white');
                    el.classList.add('text-gray-400');
                });
                const btn = document.querySelector(`button[data-tab="${tabName}"]`);
                btn.classList.add('border-b-2', 'border-primary', 'text-white');
                btn.classList.remove('text-gray-400');

                if (tabName === 'movies') admin.renderMoviesList();
                if (tabName === 'categories') admin.renderCategoriesList();
                if (tabName === 'settings') admin.renderSettingsForm();
            },
            renderMoviesList: () => {
                const list = document.getElementById('admin-movies-list');
                list.innerHTML = state.movies.map(m => `
                    <tr class="hover:bg-gray-800 transition">
                        <td class="p-3 font-medium text-white">${utils.sanitize(m.title)}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs ${m.status === 'published' ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}">${m.status}</span></td>
                        <td class="p-3">${m.year}</td>
                        <td class="p-3">
                            <button onclick="admin.editMovie('${m.id}')" class="text-blue-400 hover:text-white mr-2">Edit</button>
                            <button onclick="admin.deleteMovie('${m.id}')" class="text-red-400 hover:text-white">Delete</button>
                        </td>
                    </tr>
                `).join('');
            },
            openMovieEditor: (id = null) => {
                const form = document.getElementById('movie-form');
                form.reset();
                // Reset progress bar
                document.getElementById('upload-progress-container').classList.add('hidden');
                document.getElementById('upload-progress-bar').style.width = '0%';
                document.getElementById('upload-status-text').innerText = '';

                document.getElementById('edit-id').value = id || '';
                document.getElementById('editor-title').innerText = id ? 'Edit Movie' : 'Add Movie';
                
                // Render Categories
                const catContainer = document.getElementById('edit-categories');
                catContainer.innerHTML = state.categories.map(cat => `
                    <label class="inline-flex items-center space-x-2 bg-gray-800 px-3 py-1 rounded cursor-pointer">
                        <input type="checkbox" name="cat" value="${cat.slug}" class="form-checkbox text-primary rounded bg-gray-700 border-none">
                        <span class="text-sm text-gray-300">${cat.name}</span>
                    </label>
                `).join('');

                if (id) {
                    const m = state.movies.find(x => x.id === id);
                    document.getElementById('edit-title').value = m.title;
                    document.getElementById('edit-year').value = m.year;
                    document.getElementById('edit-desc').value = m.description;
                    document.getElementById('edit-watchUrl').value = m.watchUrl;
                    document.getElementById('edit-downloadUrl').value = m.downloadUrl || '';
                    document.getElementById('edit-status').value = m.status;
                    document.getElementById('edit-posterUrl').value = m.posterUrl;
                    document.getElementById('edit-trendingScore').value = m.trendingScore || 0;
                    
                    const inputs = document.querySelectorAll('input[name="cat"]');
                    inputs.forEach(input => {
                        if(m.categorySlugs && m.categorySlugs.includes(input.value)) input.checked = true;
                    });
                }
                ui.toggleModal('editor-modal', true);
            },
            handleMovieSave: async (e) => {
                e.preventDefault();
                const saveBtn = document.getElementById('btn-save-movie');
                saveBtn.disabled = true;
                saveBtn.innerText = 'Saving...';

                const id = document.getElementById('edit-id').value;
                const fileInput = document.getElementById('edit-poster-file');
                const titleInput = document.getElementById('edit-title').value;
                let posterUrl = document.getElementById('edit-posterUrl').value;

                // --- ROBUST IMAGEKIT UPLOAD ---
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    
                    // Validation
                    if (file.size > 10 * 1024 * 1024) {
                        utils.showToast("File too large (Max 10MB)", "error");
                        saveBtn.disabled = false;
                        saveBtn.innerText = 'Save Movie';
                        return;
                    }

                    const progressContainer = document.getElementById('upload-progress-container');
                    const progressBar = document.getElementById('upload-progress-bar');
                    const statusText = document.getElementById('upload-status-text');
                    
                    progressContainer.classList.remove('hidden');
                    statusText.innerText = 'Authenticating...';

                    try {
                        // 1. Fetch Auth Parameters Manually
                        const authRes = await fetch(IK_AUTH_ENDPOINT);
                        if (!authRes.ok) throw new Error('Auth server error');
                        const authData = await authRes.json();
                        
                        // 2. Instantiate SDK with Public Key + URL Endpoint
                        const imagekit = new ImageKit({
                            publicKey: IK_PUBLIC_KEY,
                            urlEndpoint: IK_URL_ENDPOINT
                        });

                        statusText.innerText = 'Uploading...';

                        // 3. Upload using returned auth tokens
                        const result = await new Promise((resolve, reject) => {
                            imagekit.upload({
                                file: file,
                                fileName: utils.slugify(titleInput || 'poster') + '-' + Date.now(),
                                tags: ["movie_poster"],
                                token: authData.token,
                                signature: authData.signature,
                                expire: authData.expire,
                                useUniqueFileName: true
                            }, (err, result) => {
                                if (err) reject(err);
                                else resolve(result);
                            });
                        });
                        
                        // Success
                        progressBar.style.width = '100%';
                        statusText.innerText = 'Upload Complete';
                        posterUrl = result.url;
                        
                    } catch (err) {
                        console.error("Upload Error:", err);
                        utils.showToast('Image Upload Failed: ' + (err.message || 'Unknown'), 'error');
                        saveBtn.disabled = false;
                        saveBtn.innerText = 'Save Movie';
                        return;
                    }
                }

                const dataPayload = {
                    title: titleInput,
                    year: document.getElementById('edit-year').value,
                    description: document.getElementById('edit-desc').value,
                    watchUrl: document.getElementById('edit-watchUrl').value,
                    downloadUrl: document.getElementById('edit-downloadUrl').value,
                    status: document.getElementById('edit-status').value,
                    trendingScore: parseInt(document.getElementById('edit-trendingScore').value) || 0,
                    posterUrl: posterUrl,
                    categorySlugs: Array.from(document.querySelectorAll('input[name="cat"]:checked')).map(cb => cb.value),
                    updatedAt: serverTimestamp()
                };

                try {
                    if (id) {
                        await updateDoc(doc(db, "movies", id), dataPayload);
                        utils.showToast('Movie Updated');
                    } else {
                        dataPayload.createdAt = serverTimestamp();
                        await addDoc(collection(db, "movies"), dataPayload);
                        utils.showToast('Movie Added');
                    }
                    ui.toggleModal('editor-modal', false);
                } catch (err) {
                    utils.showToast('Error saving movie to DB', 'error');
                    console.error(err);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerText = 'Save Movie';
                }
            },
            deleteMovie: async (id) => {
                if(confirm('Delete this movie permanently?')) {
                    await deleteDoc(doc(db, "movies", id));
                    utils.showToast('Movie Deleted');
                }
            },
            renderCategoriesList: () => {
                const div = document.getElementById('admin-categories-list');
                div.innerHTML = state.categories.map(cat => `
                    <div class="flex items-center justify-between bg-gray-800 p-4 rounded">
                        <div>
                            <span class="font-bold text-white">${cat.name}</span>
                            <span class="text-xs text-gray-400 ml-2">(${cat.slug})</span>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="admin.deleteCategory('${cat.id}')" class="text-red-400 text-sm">Delete</button>
                        </div>
                    </div>
                `).join('');
            },
            addCategory: async () => {
                const name = prompt("Category Name:");
                if (!name) return;
                const slug = utils.slugify(name);
                await addDoc(collection(db, "categories"), {
                    name, slug, enabled: true, order: state.categories.length + 1
                });
            },
            deleteCategory: async (id) => {
                if(confirm('Delete Category?')) await deleteDoc(doc(db, "categories", id));
            },
            renderSettingsForm: () => {
                const s = state.settings;
                document.getElementById('set-siteName').value = s.siteName;
                document.getElementById('set-heroTitle').value = s.heroTitle;
                document.getElementById('set-heroSubtitle').value = s.heroSubtitle;
                document.getElementById('set-primaryColor').value = s.theme.primaryColor;

                const togglesDiv = document.getElementById('set-toggles');
                togglesDiv.innerHTML = Object.keys(s.toggles).map(key => `
                     <label class="flex items-center space-x-2 bg-gray-700 px-3 py-2 rounded">
                        <input type="checkbox" id="toggle-${key}" ${s.toggles[key] ? 'checked' : ''}>
                        <span class="capitalize text-sm text-white">${key.replace(/([A-Z])/g, ' $1')}</span>
                    </label>
                `).join('');
            },
            saveSettings: async () => {
                const s = state.settings;
                const newToggles = {};
                Object.keys(s.toggles).forEach(key => {
                    newToggles[key] = document.getElementById(`toggle-${key}`).checked;
                });

                await updateDoc(doc(db, "settings", "global"), {
                    siteName: document.getElementById('set-siteName').value,
                    heroTitle: document.getElementById('set-heroTitle').value,
                    heroSubtitle: document.getElementById('set-heroSubtitle').value,
                    theme: { ...s.theme, primaryColor: document.getElementById('set-primaryColor').value },
                    toggles: newToggles
                });
                utils.showToast('Settings Saved');
            }
        };

        // --- 8. EVENTS & ROUTER ---
        const router = {
            navigate: (route) => {
                window.location.hash = route;
                if (route === 'admin') {
                    if (state.isAdmin) admin.check();
                    else window.location.hash = 'home';
                } else if (route === 'home') {
                    document.getElementById('admin-panel').classList.add('hidden');
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const authSection = document.getElementById('auth-section');
            
            if (user) {
                state.isAdmin = (user.email === ADMIN_EMAIL);
                authSection.innerHTML = `
                    <div class="flex items-center gap-4">
                        ${state.isAdmin ? `<button onclick="router.navigate('admin')" class="text-sm bg-gray-800 border border-gray-600 px-3 py-1 rounded text-red-400 hover:text-red-300">Admin Panel</button>` : ''}
                        <div class="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center font-bold text-white text-xs cursor-pointer" onclick="ui.logout()">
                            ${user.email[0].toUpperCase()}
                        </div>
                    </div>
                `;
                ui.toggleModal('auth-modal', false);
                data.init(); 
          } else {
  state.isAdmin = false;
  authSection.innerHTML = `<button onclick="ui.toggleModal('auth-modal', true)" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-semibold transition">Login</button>`;

  // âœ… Don't force login
  ui.toggleModal('auth-modal', false);

  // âœ… Public users must still load data
  data.init();
}
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                const errEl = document.getElementById('auth-error');
                errEl.innerText = "Invalid credentials. If you are admin, ensure correct email.";
                errEl.classList.remove('hidden');
            }
        });

        ui.logout = () => signOut(auth);

        document.getElementById('global-search').addEventListener('input', (e) => {
            state.filter = e.target.value;
            ui.renderHome();
        });

        document.getElementById('theme-toggle').addEventListener('click', utils.toggleDarkMode);

        window.admin = admin;
        window.ui = ui;
        window.router = router;

        document.getElementById('movie-form').addEventListener('submit', admin.handleMovieSave);

        if(window.location.hash === '#admin') router.navigate('admin');
        else router.navigate('home');

    </script>
</body>
</html>
