<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamVault - Loading...</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Config -->
    <script>
        // DARK MODE INIT (Immediate)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary-color)',
                        surface: 'var(--surface-color)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    aspectRatio: {
                        'poster': '2 / 3',
                        'video': '16 / 9'
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- ImageKit SDK -->
    <script src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --surface-color: #1f2937;
        }
        body { font-family: 'Inter', sans-serif; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-dark {
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Loader */
        .loader {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="fixed w-full z-50 glass-dark shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 gap-4">
                <!-- Logo -->
                <div class="flex-shrink-0 cursor-pointer flex items-center gap-2" onclick="router.navigate('home')">
                    <img id="nav-logo-img" class="h-8 hidden" alt="Logo">
                    <span id="nav-logo-text" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                        StreamVault
                    </span>
                </div>
                
                <!-- Search & Filters -->
                <div class="hidden md:flex flex-1 max-w-2xl mx-4 gap-2" id="search-container">
                    <input type="text" id="global-search" placeholder="Search..." 
                        class="flex-grow bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary border border-gray-300 dark:border-gray-700">
                    
                    <select id="filter-lang" class="bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg px-3 py-2 border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                        <option value="all">All Lang</option>
                        <option value="en">English</option>
                        <option value="bn">Bangla</option>
                        <option value="hi">Hindi</option>
                        <option value="zh">Chinese</option>
                        <option value="ko">Korean</option>
                    </select>

                    <select id="filter-year" class="bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg px-3 py-2 border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                        <option value="all">All Years</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <!-- Right Menu -->
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-300 dark:hover:bg-gray-700 transition">
                        <span id="theme-icon">ðŸŒ™</span>
                    </button>
                    <div id="auth-section"><!-- Injected via JS --></div>
                </div>
            </div>
            <!-- Mobile Filters (visible only on mobile) -->
            <div class="md:hidden flex gap-2 pb-3" id="mobile-filters">
                <input type="text" id="mobile-search" placeholder="Search..." class="w-full bg-gray-800 rounded px-2 py-1 text-sm border border-gray-700">
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="app" class="flex-grow pt-24 px-4 max-w-7xl mx-auto w-full min-h-screen">
        <div class="flex justify-center items-center h-64">
            <div class="loader"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="footer" class="border-t border-gray-200 dark:border-gray-800 mt-12 bg-gray-200 dark:bg-gray-900 pt-12 pb-8 hidden">
        <div class="max-w-7xl mx-auto px-4 flex flex-col items-center">
            <!-- Social Links -->
            <div id="social-links-container" class="flex gap-6 mb-8 hidden">
                <!-- Injected via JS -->
            </div>
            
            <p class="text-gray-500 text-sm mb-2">&copy; <span id="footer-year"></span> <span id="footer-site-name">StreamVault</span>.</p>
            <p class="text-gray-600 text-xs">All content is legally licensed or public domain.</p>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-sm w-full shadow-2xl border border-gray-200 dark:border-gray-700 relative">
            <button onclick="ui.toggleModal('auth-modal', false)" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white">&times;</button>
            <h2 id="auth-title" class="text-2xl font-bold mb-2 text-center text-gray-900 dark:text-white">Sign In</h2>
            <p id="auth-subtitle" class="text-center text-gray-500 dark:text-gray-400 text-sm mb-6">Welcome back to the library</p>
            
            <form id="auth-form" class="space-y-4">
                <input type="email" id="email" placeholder="Email Address" required class="w-full bg-gray-100 dark:bg-gray-700 rounded p-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                <input type="password" id="password" placeholder="Password" required class="w-full bg-gray-100 dark:bg-gray-700 rounded p-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                
                <button type="submit" id="btn-auth-submit" class="w-full bg-primary hover:opacity-90 text-white font-bold py-3 rounded transition">Sign In</button>
                
                <div id="auth-error" class="text-red-500 dark:text-red-400 text-sm text-center hidden p-2 bg-red-100 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800"></div>
            </form>

            <div class="mt-4 text-center space-y-2">
                <button onclick="authManager.toggleMode()" id="auth-toggle-btn" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-500">New here? Create an account</button>
                <div class="block">
                    <button onclick="authManager.forgotPassword()" class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Forgot Password?</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notif-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md fade-in">
        <div class="bg-gray-900 rounded-2xl max-w-lg w-full mx-4 shadow-2xl border border-gray-700 overflow-hidden relative">
            <button onclick="ui.closeNotification()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10 bg-black/50 rounded-full w-8 h-8 flex items-center justify-center">&times;</button>
            <div id="notif-image-container" class="h-48 w-full bg-cover bg-center hidden"></div>
            <div class="p-8 text-center">
                <h2 id="notif-title" class="text-2xl font-bold text-white mb-3"></h2>
                <p id="notif-message" class="text-gray-300 mb-6 leading-relaxed"></p>
                <a id="notif-link" href="#" target="_blank" class="hidden inline-block bg-primary hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full transition shadow-lg shadow-blue-500/30">
                    Learn More
                </a>
            </div>
        </div>
    </div>

    <!-- Movie Details Modal -->
    <div id="movie-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md fade-in p-4">
        <div class="bg-white dark:bg-gray-900 rounded-2xl max-w-5xl w-full mx-auto overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col md:flex-row max-h-[90vh]">
            <div id="movie-modal-poster" class="w-full md:w-1/3 bg-cover bg-center h-48 md:h-auto shrink-0"></div>
            <div class="p-8 w-full md:w-2/3 flex flex-col overflow-y-auto">
                <div class="flex justify-between items-start">
                    <h2 id="movie-modal-title" class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-2"></h2>
                    <button onclick="ui.toggleModal('movie-modal', false)" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div class="flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400 mb-4">
                    <span id="movie-modal-year" class="bg-gray-200 dark:bg-gray-800 px-2 py-1 rounded border border-gray-300 dark:border-gray-700"></span>
                    <span id="movie-modal-lang" class="bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 px-2 py-1 rounded uppercase"></span>
                    <span id="movie-modal-rating" class="text-yellow-500 font-bold"></span>
                </div>
                <p id="movie-modal-desc" class="text-gray-700 dark:text-gray-300 leading-relaxed mb-6"></p>
                
                <div class="mt-auto space-y-3">
                    <a id="movie-modal-watch" href="#" target="_blank" class="block w-full text-center bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-500/30">
                        â–¶ Watch Now
                    </a>
                    <a id="movie-modal-download" href="#" target="_blank" class="hidden block w-full text-center border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-900 dark:text-white py-3 rounded-lg transition">
                        â¬‡ Download
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="fixed inset-0 z-[55] hidden bg-gray-50 dark:bg-gray-900 overflow-y-auto">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-blue-600">Admin Dashboard</h1>
                <button onclick="router.navigate('home')" class="bg-gray-200 dark:bg-gray-800 px-4 py-2 rounded text-gray-900 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-700">Exit Admin</button>
            </div>

            <!-- Tabs -->
            <div class="flex space-x-2 border-b border-gray-200 dark:border-gray-700 mb-6 overflow-x-auto pb-2">
                <button onclick="admin.switchTab('movies')" class="admin-tab whitespace-nowrap px-4 py-2 text-gray-900 dark:text-white border-b-2 border-primary" data-tab="movies">Movies</button>
                <button onclick="admin.switchTab('categories')" class="admin-tab whitespace-nowrap px-4 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="categories">Categories</button>
                <button onclick="admin.switchTab('notifications')" class="admin-tab whitespace-nowrap px-4 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="notifications">Notifications</button>
                <button onclick="admin.switchTab('settings')" class="admin-tab whitespace-nowrap px-4 py-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white" data-tab="settings">Settings</button>
            </div>

            <!-- Tab: Movies -->
            <div id="tab-movies" class="admin-content">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-semibold dark:text-white">Library Content</h2>
                    <button onclick="admin.openMovieEditor()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">+ Add Movie</button>
                </div>
                <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow">
                    <table class="w-full text-left text-sm text-gray-600 dark:text-gray-400">
                        <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 uppercase"><tr><th class="p-3">Title</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead>
                        <tbody id="admin-movies-list" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Categories -->
            <div id="tab-categories" class="admin-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-semibold dark:text-white">Manage Categories</h2>
                    <button onclick="admin.addCategory()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">+ Add Category</button>
                </div>
                <div id="admin-categories-list" class="space-y-2"></div>
            </div>

            <!-- Tab: Notifications -->
            <div id="tab-notifications" class="admin-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-semibold dark:text-white">Popup Notifications</h2>
                    <button onclick="admin.openNotifEditor()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">+ New Notification</button>
                </div>
                <div id="admin-notif-list" class="space-y-4"></div>
            </div>

            <!-- Tab: Settings -->
            <div id="tab-settings" class="admin-content hidden space-y-6 max-w-4xl">
                <!-- Site Identity -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Site Identity</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <input type="text" id="set-siteName" placeholder="Site Name" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full border border-gray-300 dark:border-gray-600">
                        <div class="flex gap-2">
                             <input type="text" id="set-logoUrl" placeholder="Logo URL" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full border border-gray-300 dark:border-gray-600">
                             <button onclick="document.getElementById('set-logo-file').click()" class="bg-gray-200 dark:bg-gray-600 px-3 rounded text-gray-900 dark:text-white">Upload</button>
                             <input type="file" id="set-logo-file" class="hidden" onchange="admin.handleUpload(this, 'set-logoUrl', 'upload-status-logo')">
                             <span id="upload-status-logo" class="text-xs text-green-500 self-center"></span>
                        </div>
                    </div>
                </div>

                <!-- Featured & Hero -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Hero Section</h3>
                    <div class="grid md:grid-cols-1 gap-4">
                         <div>
                            <label class="text-sm text-gray-500 dark:text-gray-400">Featured Movie (Hero Background)</label>
                            <select id="set-featuredMovie" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full mt-1 border border-gray-300 dark:border-gray-600"></select>
                         </div>
                        <input type="text" id="set-heroTitle" placeholder="Hero Title" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full border border-gray-300 dark:border-gray-600">
                        <input type="text" id="set-heroSubtitle" placeholder="Hero Subtitle" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full border border-gray-300 dark:border-gray-600">
                    </div>
                </div>

                <!-- Appearance & Layout -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Appearance</h3>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-sm text-gray-500 dark:text-gray-400">Primary Color</label>
                            <input type="color" id="set-primaryColor" class="w-full h-10 rounded mt-1 cursor-pointer">
                        </div>
                        <div>
                            <label class="text-sm text-gray-500 dark:text-gray-400">Poster Style</label>
                            <select id="set-posterStyle" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full mt-1 border border-gray-300 dark:border-gray-600">
                                <option value="poster">Vertical (2:3) - Best for Movies</option>
                                <option value="backdrop">Thumbnail (16:9) - Best for Videos</option>
                            </select>
                        </div>
                    </div>
                    <label class="text-sm text-gray-500 dark:text-gray-400 block mb-2">Homepage Section Order (trending, categories, recent, social)</label>
                    <input type="text" id="set-sectionOrder" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full border border-gray-300 dark:border-gray-600">
                </div>

                <!-- Social Links -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Social Links</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <input type="text" id="set-social-youtube" placeholder="YouTube URL" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600">
                        <input type="text" id="set-social-telegram" placeholder="Telegram URL" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600">
                        <input type="text" id="set-social-x" placeholder="X (Twitter) URL" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600">
                    </div>
                </div>

                <!-- Admin Management -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Admins</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Separate emails with commas.</p>
                    <textarea id="set-admins" rows="3" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-full border border-gray-300 dark:border-gray-600"></textarea>
                </div>

                <!-- Toggles -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-200 dark:border-gray-700 shadow">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Configuration</h3>
                    <div class="flex gap-4 flex-wrap mb-4" id="set-toggles"></div>
                    <div class="mt-4">
                        <label class="text-sm text-gray-500 dark:text-gray-400">Notification Delay (Seconds)</label>
                        <input type="number" id="set-notifDelay" class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-gray-900 dark:text-white w-24 ml-2 border border-gray-300 dark:border-gray-600" value="5">
                    </div>
                </div>
                
                <button onclick="admin.saveSettings()" class="bg-primary hover:opacity-90 text-white px-8 py-3 rounded font-bold w-full shadow-lg">Save All Settings</button>
            </div>
        </div>
    </div>

    <!-- Movie Editor (Admin) -->
    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-90 backdrop-blur">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 dark:text-white" id="editor-title">Edit Movie</h2>
            <form id="movie-form" class="space-y-3">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="edit-title" placeholder="Movie Title" required class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                    <input type="number" id="edit-year" placeholder="Year" required class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <select id="edit-lang" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                        <option value="en">English</option>
                        <option value="bn">Bangla</option>
                        <option value="hi">Hindi</option>
                        <option value="zh">Chinese</option>
                        <option value="ko">Korean</option>
                    </select>
                    <input type="number" id="edit-trendingScore" placeholder="Score (0-100)" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white">
                </div>

                <textarea id="edit-desc" placeholder="Description" rows="3" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full"></textarea>
                
                <!-- Poster Upload -->
                <div class="border border-dashed border-gray-400 dark:border-gray-600 p-4 rounded text-center relative">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Poster/Thumbnail Image</p>
                    <input type="file" id="edit-poster-file" accept="image/*" class="text-sm text-gray-500 w-full" onchange="admin.handleUpload(this, 'edit-posterUrl', 'upload-status-movie')">
                    <input type="hidden" id="edit-posterUrl">
                    <p id="upload-status-movie" class="text-xs text-green-500 mt-1 h-4"></p>
                </div>

                <input type="url" id="edit-watchUrl" placeholder="Watch URL" required class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                <input type="url" id="edit-downloadUrl" placeholder="Download URL (Optional)" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                
                <div class="grid grid-cols-1">
                    <select id="edit-status" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white"><option value="draft">Draft</option><option value="published">Published</option></select>
                </div>

                <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded">
                    <p class="text-sm dark:text-gray-300 mb-2">Categories</p>
                    <div id="edit-categories" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="ui.toggleModal('editor-modal', false)" class="text-gray-500 hover:text-gray-800 dark:hover:text-white">Cancel</button>
                    <button type="submit" id="btn-save-movie" class="bg-primary px-4 py-2 rounded text-white">Save Movie</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Editor (Admin) -->
    <div id="notif-editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-90 backdrop-blur">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-lg border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4 dark:text-white" id="notif-editor-title">Edit Notification</h2>
            <form id="notif-form" class="space-y-3">
                <input type="hidden" id="notif-id">
                <input type="text" id="notif-edit-title" placeholder="Title" required class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                <textarea id="notif-edit-message" placeholder="Message" rows="3" required class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full"></textarea>
                
                <div class="flex gap-2 items-center">
                     <input type="text" id="notif-edit-imageUrl" placeholder="Image URL (Optional)" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                     <button type="button" onclick="document.getElementById('notif-file').click()" class="bg-gray-300 dark:bg-gray-600 px-2 py-1 rounded">Up</button>
                     <input type="file" id="notif-file" class="hidden" onchange="admin.handleUpload(this, 'notif-edit-imageUrl', 'upload-status-notif')">
                </div>
                <p id="upload-status-notif" class="text-xs text-green-500 h-4"></p>

                <input type="text" id="notif-edit-linkUrl" placeholder="Action Link URL (Optional)" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white w-full">
                
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="notif-edit-priority" placeholder="Priority (High shows first)" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white">
                    <input type="number" id="notif-edit-maxShows" placeholder="Max Shows Per User" value="1" class="bg-gray-100 dark:bg-gray-700 p-2 rounded dark:text-white">
                </div>
                <label class="flex items-center gap-2 dark:text-white">
                    <input type="checkbox" id="notif-edit-enabled"> Enabled
                </label>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="ui.toggleModal('notif-editor-modal', false)" class="text-gray-500 dark:hover:text-white">Cancel</button>
                    <button type="submit" id="btn-save-notif" class="bg-primary px-4 py-2 rounded text-white">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 z-[90] border border-gray-700">
        <span id="toast-msg"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, where, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyABgaLI-JUjeB45cwW0De6iGyy8io72Opg",
            authDomain: "abmovie-d4826.firebaseapp.com",
            projectId: "abmovie-d4826",
            storageBucket: "abmovie-d4826.firebasestorage.app",
            messagingSenderId: "187818385326",
            appId: "1:187818385326:web:4bdffca6053e08033c323f"
        };
        
        const BOOTSTRAP_ADMIN_EMAIL = "bristyxom@gmail.com";
        const IK_PUBLIC_KEY = "public_Wt+RjZXgdesltZmb4M/5SO8ncZk=";
        const IK_URL_ENDPOINT = "https://ik.imagekit.io/4maqtfplt";
        const IK_AUTH_ENDPOINT = "/api/imagekit-auth"; // NOTE: User needs to ensure this exists or use client-side signature generation if no backend.

        const DEFAULT_SETTINGS = {
            siteName: "StreamVault",
            logoUrl: "",
            heroTitle: "Welcome",
            heroSubtitle: "Stream your favorite content",
            featuredMovieId: "",
            posterStyle: "poster",
            sectionOrder: ["trending", "categories", "recent", "social"],
            theme: { primaryColor: "#3b82f6" },
            toggles: { showFooter: true, showSearch: true, showTrending: true, showSocialSection: true },
            socialLinks: { youtube: "", telegram: "", x: "" },
            admins: [BOOTSTRAP_ADMIN_EMAIL],
            notificationDelaySeconds: 5
        };

        const LANG_MAP = { en: "English", bn: "Bangla", hi: "Hindi", zh: "Chinese", ko: "Korean" };

        // INIT
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        const state = {
            user: null,
            isAdmin: false,
            settings: null,
            categories: [],
            movies: [],
            notifications: [],
            filter: '',
            filterLang: 'all',
            filterYear: 'all',
            authMode: 'login',
            settingsLoaded: false
        };

        // UTILS
        const utils = {
            sanitize: (str) => {
                const temp = document.createElement('div');
                temp.textContent = str || '';
                return temp.innerHTML;
            },
            showToast: (msg, type = 'info') => {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                toast.classList.remove('translate-y-20');
                toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded shadow-lg transform transition-transform duration-300 z-[90] border ${type === 'error' ? 'bg-red-900 border-red-700 text-white' : 'bg-gray-800 border-gray-700 text-white'}`;
                setTimeout(() => toast.classList.add('translate-y-20'), 3000);
            },
            slugify: (text) => text.toString().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '')
        };

        // UI CONTROLLER
        const ui = {
            toggleModal: (id, show) => {
                const el = document.getElementById(id);
                show ? el.classList.remove('hidden') : el.classList.add('hidden');
                if(id === 'auth-modal') document.getElementById('auth-error').classList.add('hidden');
            },
            closeNotification: () => ui.toggleModal('notif-modal', false),
            updateAuthUI: () => {
                const authSection = document.getElementById('auth-section');
                if (state.user) {
                    authSection.innerHTML = `
                        <div class="flex items-center gap-4">
                            ${state.isAdmin ? `<button onclick="router.navigate('admin')" class="text-xs bg-red-600 border border-red-500 text-white px-3 py-1 rounded hover:bg-red-700">Admin</button>` : ''}
                            <div class="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center font-bold text-white text-xs cursor-pointer" onclick="ui.logout()" title="Sign Out">
                                ${state.user.email[0].toUpperCase()}
                            </div>
                        </div>
                    `;
                } else {
                    authSection.innerHTML = `<button onclick="ui.toggleModal('auth-modal', true)" class="bg-primary hover:bg-blue-600 text-white px-5 py-2 rounded-full text-sm font-semibold transition shadow-lg shadow-blue-500/20">Login</button>`;
                }
            },
            applySettings: () => {
                if (!state.settings) return;
                const s = state.settings;
                
                document.documentElement.style.setProperty('--primary-color', s.theme?.primaryColor || '#3b82f6');
                document.title = `${s.siteName || 'StreamVault'} - Home`;
                document.getElementById('nav-logo-text').innerText = s.siteName || 'StreamVault';
                document.getElementById('footer-site-name').innerText = s.siteName || 'StreamVault';
                document.getElementById('footer-year').innerText = new Date().getFullYear();

                const logoImg = document.getElementById('nav-logo-img');
                const logoText = document.getElementById('nav-logo-text');
                if (s.logoUrl) {
                    logoImg.src = s.logoUrl;
                    logoImg.classList.remove('hidden');
                    logoText.classList.add('hidden'); 
                    logoText.classList.add('md:block'); 
                } else {
                    logoImg.classList.add('hidden');
                    logoText.classList.remove('hidden');
                }

                const toggleEl = (id, show) => {
                    const el = document.getElementById(id);
                    if(el) el.classList.toggle('hidden', !show);
                };
                toggleEl('footer', s.toggles?.showFooter ?? true);
                toggleEl('search-container', s.toggles?.showSearch ?? true);

                // Social Links (Footer)
                const socialContainer = document.getElementById('social-links-container');
                if (s.toggles?.showSocialSection && s.socialLinks) {
                    socialContainer.classList.remove('hidden');
                    socialContainer.innerHTML = '';
                    const icons = {
                        youtube: '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/></svg>',
                        telegram: '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>',
                        x: '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>'
                    };
                    Object.keys(s.socialLinks).forEach(key => {
                        if (s.socialLinks[key]) {
                            socialContainer.innerHTML += `<a href="${s.socialLinks[key]}" target="_blank" class="text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white transition">${icons[key] || key}</a>`;
                        }
                    });
                } else {
                    socialContainer.classList.add('hidden');
                }

                ui.renderHome();
            },
            renderHome: () => {
                if (!state.settings || !state.settingsLoaded) return;
                const published = state.movies.filter(m => m.status === 'published');
                
                // Update Year Filter Options
                const years = [...new Set(published.map(m => m.year))].sort((a,b)=>b-a);
                const yearSelect = document.getElementById('filter-year');
                if(yearSelect.options.length <= 1) { // Populate only once or on major updates
                    years.forEach(y => {
                        const opt = document.createElement('option');
                        opt.value = y;
                        opt.innerText = y;
                        yearSelect.appendChild(opt);
                    });
                }

                // Filtering
                const filtered = published.filter(m => {
                    const matchText = (m.title||'').toLowerCase().includes(state.filter.toLowerCase());
                    const matchLang = state.filterLang === 'all' || m.language === state.filterLang;
                    const matchYear = state.filterYear === 'all' || m.year == state.filterYear;
                    return matchText && matchLang && matchYear;
                });

                let html = '';

                // Hero Section (Only show if not searching/filtering)
                const isFiltering = state.filter || state.filterLang !== 'all' || state.filterYear !== 'all';
                let heroMovie = null;
                if (!isFiltering) {
                    if (state.settings.featuredMovieId) {
                        heroMovie = published.find(m => m.id === state.settings.featuredMovieId);
                    }
                    if (!heroMovie && published.length > 0) heroMovie = published[0];

                    if (heroMovie) {
                        html += `
                            <div class="relative w-full h-[60vh] rounded-2xl overflow-hidden mb-12 shadow-2xl group cursor-pointer" onclick="ui.openMovie('${heroMovie.id}')">
                                <div class="absolute inset-0 bg-gradient-to-t from-gray-100 dark:from-gray-900 via-gray-100/60 dark:via-gray-900/60 to-transparent z-10"></div>
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-1000 group-hover:scale-105" 
                                     style="background-image: url('${heroMovie.posterUrl}')">
                                </div>
                                <div class="absolute bottom-0 left-0 p-8 z-20 max-w-2xl fade-in">
                                    <span class="bg-primary text-white text-xs px-2 py-1 rounded uppercase font-bold tracking-wider mb-2 inline-block">Featured</span>
                                    <h1 class="text-4xl md:text-6xl font-bold text-gray-900 dark:text-white mb-2 drop-shadow-lg">${state.settings.heroTitle || 'Welcome'}</h1>
                                    <p class="text-lg text-gray-800 dark:text-gray-200 mb-6 drop-shadow-md line-clamp-2">${state.settings.heroSubtitle || ''}</p>
                                    <button class="bg-primary hover:bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-primary/30 transition flex items-center gap-2">
                                        <span>â–¶ Watch Now</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }

                const renderRow = (title, moviesList) => {
                    if (!moviesList.length) return '';
                    const isBackdrop = state.settings.posterStyle === 'backdrop';
                    // 3 cols for backdrop, 5 cols for poster (on lg screens)
                    const gridClass = isBackdrop 
                        ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" 
                        : "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6";

                    return `
                        <div class="mb-12 fade-in">
                            <h2 class="text-2xl font-bold mb-6 pl-2 border-l-4 border-primary text-gray-900 dark:text-white flex items-center gap-2">
                                ${title} <span class="text-xs text-gray-500 font-normal ml-2">(${moviesList.length})</span>
                            </h2>
                            <div class="${gridClass}">
                                ${moviesList.map(m => ui.components.movieCard(m, isBackdrop)).join('')}
                            </div>
                        </div>
                    `;
                };

                const renderSocialSection = () => {
                    if (!state.settings.socialLinks) return '';
                    const s = state.settings.socialLinks;
                    if (!s.youtube && !s.telegram && !s.x) return '';
                    
                    return `
                    <div class="mb-12 fade-in bg-white dark:bg-gray-800 rounded-xl p-8 shadow-lg border border-gray-200 dark:border-gray-700 text-center">
                        <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Join Our Community</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Stay updated with latest releases</p>
                        <div class="flex justify-center gap-4 flex-wrap">
                            ${s.youtube ? `<a href="${s.youtube}" target="_blank" class="px-6 py-2 bg-red-600 text-white rounded-full font-bold hover:bg-red-700 transition">YouTube</a>` : ''}
                            ${s.telegram ? `<a href="${s.telegram}" target="_blank" class="px-6 py-2 bg-blue-500 text-white rounded-full font-bold hover:bg-blue-600 transition">Telegram</a>` : ''}
                            ${s.x ? `<a href="${s.x}" target="_blank" class="px-6 py-2 bg-black text-white rounded-full font-bold hover:bg-gray-800 transition">X (Twitter)</a>` : ''}
                        </div>
                    </div>
                    `;
                };

                if (isFiltering) {
                    html += renderRow(`Search Results`, filtered);
                } else {
                    const order = state.settings.sectionOrder && state.settings.sectionOrder.length 
                        ? state.settings.sectionOrder 
                        : ['trending', 'categories', 'recent', 'social'];
                    
                    order.forEach(section => {
                        const s = section.trim().toLowerCase();
                        if (s === 'trending' && state.settings.toggles?.showTrending) {
                            const trending = [...published].sort((a,b) => (b.trendingScore || 0) - (a.trendingScore || 0)).slice(0, 5);
                            html += renderRow("Trending Now ðŸ”¥", trending);
                        }
                        else if (s === 'recent') {
                            // Sort by createdAt desc if possible, else year
                            const recent = [...published].sort((a,b) => {
                                const ta = a.createdAt?.seconds || 0;
                                const tb = b.createdAt?.seconds || 0;
                                return tb - ta;
                            }).slice(0, 10);
                            html += renderRow("Recently Added", recent);
                        }
                        else if (s === 'categories') {
                            state.categories.forEach(cat => {
                                if (cat.enabled) {
                                    const catMovies = published.filter(m => m.categorySlugs?.includes(cat.slug));
                                    html += renderRow(cat.name, catMovies);
                                }
                            });
                        }
                        else if (s === 'social' && state.settings.toggles?.showSocialSection) {
                            html += renderSocialSection();
                        }
                    });
                }
                document.getElementById('app').innerHTML = html;
            },
            components: {
                movieCard: (movie, isBackdrop) => {
                    const aspect = isBackdrop ? 'aspect-video' : 'aspect-poster';
                    const langBadge = movie.language ? `<span class="absolute top-2 right-2 bg-black/60 text-white text-[10px] px-1 rounded backdrop-blur uppercase">${movie.language}</span>` : '';
                    
                    return `
                        <div class="relative group cursor-pointer bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg transition hover:shadow-primary/20 hover:-translate-y-1 border border-gray-200 dark:border-gray-700" onclick="ui.openMovie('${movie.id}')">
                            <div class="${aspect} overflow-hidden relative bg-gray-300 dark:bg-gray-700">
                                <img src="${movie.posterUrl}" alt="${utils.sanitize(movie.title)}" loading="lazy" 
                                    class="w-full h-full object-cover transition duration-500 group-hover:scale-110 group-hover:opacity-75">
                                ${langBadge}
                                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                                    <div class="bg-white/20 backdrop-blur rounded-full p-3">
                                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3">
                                <h3 class="font-semibold text-gray-900 dark:text-gray-100 truncate text-sm md:text-base">${utils.sanitize(movie.title)}</h3>
                                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <span>${movie.year}</span>
                                    <span>${movie.categorySlugs?.[0] || 'Movie'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },
            openMovie: (id) => {
                const m = state.movies.find(x => x.id === id);
                if(!m) return;
                
                document.getElementById('movie-modal-title').innerText = m.title;
                document.getElementById('movie-modal-desc').innerText = m.description;
                document.getElementById('movie-modal-year').innerText = m.year;
                document.getElementById('movie-modal-lang').innerText = m.language || 'EN';
                document.getElementById('movie-modal-rating').innerText = `â˜… ${m.trendingScore || '-'}`;
                document.getElementById('movie-modal-poster').style.backgroundImage = `url('${m.posterUrl}')`;
                document.getElementById('movie-modal-watch').href = m.watchUrl;
                
                const dlBtn = document.getElementById('movie-modal-download');
                if (m.downloadUrl && state.settings.toggles?.allowDownloads !== false) { 
                     dlBtn.href = m.downloadUrl;
                     dlBtn.classList.remove('hidden');
                } else {
                    dlBtn.classList.add('hidden');
                }
                ui.toggleModal('movie-modal', true);
            },
            logout: () => {
                signOut(auth).then(() => {
                    utils.showToast("Logged out");
                    window.location.reload();
                });
            }
        };

        // AUTH MANAGER
        const authManager = {
            toggleMode: () => {
                state.authMode = state.authMode === 'login' ? 'signup' : 'login';
                document.getElementById('auth-title').innerText = state.authMode === 'login' ? 'Sign In' : 'Create Account';
                document.getElementById('auth-subtitle').innerText = state.authMode === 'login' ? 'Welcome back' : 'Join StreamVault today';
                document.getElementById('btn-auth-submit').innerText = state.authMode === 'login' ? 'Sign In' : 'Sign Up';
                document.getElementById('auth-toggle-btn').innerText = state.authMode === 'login' ? 'New here? Create an account' : 'Already have an account? Sign In';
                document.getElementById('auth-error').classList.add('hidden');
            },
            handleAuth: async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const errEl = document.getElementById('auth-error');
                const btn = document.getElementById('btn-auth-submit');
                
                btn.disabled = true;
                btn.classList.add('opacity-50');
                errEl.classList.add('hidden');

                try {
                    if (state.authMode === 'signup') {
                        await createUserWithEmailAndPassword(auth, email, password);
                        utils.showToast("Account created! Welcome.");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        utils.showToast("Welcome back");
                    }
                    ui.toggleModal('auth-modal', false);
                } catch (error) {
                    console.error("Auth Error:", error);
                    errEl.innerText = error.message.replace('Firebase:', '').trim();
                    errEl.classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }
            },
            forgotPassword: async () => {
                const email = prompt("Enter your email for reset link:");
                if(email) {
                    try {
                        await sendPasswordResetEmail(auth, email);
                        utils.showToast("Reset link sent to " + email);
                    } catch(e) {
                        utils.showToast("Error sending link", "error");
                    }
                }
            }
        };

        // NOTIFICATION SYSTEM
        const notifManager = {
            init: () => {
                const delay = (state.settings?.notificationDelaySeconds || 5) * 1000;
                setTimeout(() => notifManager.check(), delay);
            },
            check: async () => {
                if (!state.notifications.length) return;
                
                // Get eligible notifications (enabled, high priority first)
                const eligible = state.notifications
                    .filter(n => n.enabled)
                    .sort((a,b) => (b.priority || 0) - (a.priority || 0));

                if (!eligible.length) return;

                let viewCounts = {};
                try { viewCounts = JSON.parse(localStorage.getItem('notifViews') || '{}'); } catch(e){}

                for (const note of eligible) {
                    const views = viewCounts[note.id] || 0;
                    if (views < (note.maxShows || 1)) {
                        notifManager.show(note);
                        
                        // Increment
                        viewCounts[note.id] = views + 1;
                        localStorage.setItem('notifViews', JSON.stringify(viewCounts));
                        
                        if(state.user) {
                             const ref = doc(db, `profiles/${state.user.uid}/notifViews/${note.id}`);
                             setDoc(ref, { count: increment(1), lastShown: serverTimestamp() }, { merge: true });
                        }
                        break; // Only show one per session load
                    }
                }
            },
            show: (note) => {
                document.getElementById('notif-title').innerText = note.title;
                document.getElementById('notif-message').innerText = note.message;
                const imgContainer = document.getElementById('notif-image-container');
                const btn = document.getElementById('notif-link');
                
                if (note.imageUrl) {
                    imgContainer.style.backgroundImage = `url('${note.imageUrl}')`;
                    imgContainer.classList.remove('hidden');
                } else {
                    imgContainer.classList.add('hidden');
                }

                if (note.linkUrl) {
                    btn.href = note.linkUrl;
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
                
                ui.toggleModal('notif-modal', true);
            }
        };

        // DATA LAYER
        const data = {
            init: async () => {
                // 1. Settings (Critical with Self-Heal)
                onSnapshot(doc(db, "settings", "global"), async (docSnap) => {
                    if (docSnap.exists()) {
                        state.settings = docSnap.data();
                        
                        // Merge missing defaults safely
                        if (!state.settings.toggles || !state.settings.admins) {
                             await setDoc(doc(db, "settings", "global"), DEFAULT_SETTINGS, { merge: true });
                        }
                    } else {
                        // Create Default
                        await setDoc(doc(db, "settings", "global"), DEFAULT_SETTINGS);
                        state.settings = DEFAULT_SETTINGS;
                    }
                    
                    state.settingsLoaded = true;
                    
                    // Admin Check (Case Insensitive + Bootstrap)
                    if (state.user) {
                        const email = state.user.email.toLowerCase();
                        const adminList = (state.settings.admins || []).map(a => a.toLowerCase());
                        state.isAdmin = (email === BOOTSTRAP_ADMIN_EMAIL.toLowerCase()) || adminList.includes(email);
                    } else {
                        state.isAdmin = false;
                    }

                    ui.updateAuthUI();
                    ui.applySettings();
                    data.loadContent();
                    
                    // Start notification timer
                    if(!state.isAdmin) notifManager.init();

                });
            },
            loadContent: () => {
                // Categories
                onSnapshot(query(collection(db, "categories"), orderBy("order")), (snap) => {
                    state.categories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    ui.renderHome();
                    if(state.isAdmin) admin.renderCategoriesList();
                });

                // Movies
                // Fallback for sorting if index missing
                let q = query(collection(db, "movies")); 
                // We fetch all then sort in JS to avoid complex composite index issues for the user
                
                onSnapshot(q, (snap) => {
                    state.movies = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    ui.renderHome();
                    if(state.isAdmin) admin.renderMoviesList();
                });

                // Notifications
                const notifQ = query(collection(db, "notifications"));
                onSnapshot(notifQ, (snap) => {
                    state.notifications = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    if(state.isAdmin) admin.renderNotifList();
                });
            }
        };

        // ADMIN CONTROLLER
        const admin = {
            switchTab: (tab) => {
                document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
                document.querySelectorAll('.admin-tab').forEach(t => {
                    t.classList.remove('border-b-2', 'border-primary');
                    t.classList.remove('dark:text-white', 'text-gray-900');
                    t.classList.add('text-gray-500', 'dark:text-gray-400');
                });
                const btn = document.querySelector(`button[data-tab="${tab}"]`);
                btn.classList.add('border-b-2', 'border-primary', 'dark:text-white', 'text-gray-900');
                btn.classList.remove('text-gray-500', 'dark:text-gray-400');

                if(tab === 'settings') admin.renderSettingsForm();
            },
            renderMoviesList: () => {
                // Sort by createdAt desc for admin
                const sorted = [...state.movies].sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                const html = sorted.map(m => `
                    <tr class="hover:bg-gray-100 dark:hover:bg-gray-700 transition border-b border-gray-200 dark:border-gray-700">
                        <td class="p-3 font-medium text-gray-900 dark:text-white">${utils.sanitize(m.title)} <span class="text-xs text-gray-500 block">${m.year} â€¢ ${m.language || 'en'}</span></td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs ${m.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${m.status}</span></td>
                        <td class="p-3">
                            <button onclick="admin.openMovieEditor('${m.id}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-white mr-3">Edit</button>
                            <button onclick="admin.deleteMovie('${m.id}')" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-white">Del</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('admin-movies-list').innerHTML = html;
            },
            openMovieEditor: (id) => {
                const form = document.getElementById('movie-form');
                form.reset();
                document.getElementById('edit-id').value = id || '';
                document.getElementById('editor-title').innerText = id ? 'Edit Movie' : 'Add Movie';
                document.getElementById('upload-status-movie').innerText = '';

                const catContainer = document.getElementById('edit-categories');
                catContainer.innerHTML = state.categories.map(cat => `
                    <label class="inline-flex items-center space-x-2 bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded cursor-pointer border border-gray-300 dark:border-gray-600">
                        <input type="checkbox" name="cat" value="${cat.slug}" class="form-checkbox text-primary rounded bg-gray-100 dark:bg-gray-600 border-none">
                        <span class="text-xs text-gray-800 dark:text-gray-300">${cat.name}</span>
                    </label>
                `).join('');

                if (id) {
                    const m = state.movies.find(x => x.id === id);
                    if(m) {
                        document.getElementById('edit-title').value = m.title;
                        document.getElementById('edit-year').value = m.year;
                        document.getElementById('edit-lang').value = m.language || 'en';
                        document.getElementById('edit-desc').value = m.description;
                        document.getElementById('edit-watchUrl').value = m.watchUrl;
                        document.getElementById('edit-downloadUrl').value = m.downloadUrl || '';
                        document.getElementById('edit-status').value = m.status;
                        document.getElementById('edit-posterUrl').value = m.posterUrl;
                        document.getElementById('edit-trendingScore').value = m.trendingScore || 0;
                        m.categorySlugs?.forEach(slug => {
                            const cb = document.querySelector(`input[name="cat"][value="${slug}"]`);
                            if(cb) cb.checked = true;
                        });
                    }
                }
                ui.toggleModal('editor-modal', true);
            },
            handleMovieSave: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-save-movie');
                btn.disabled = true;
                btn.innerText = 'Saving...';
                
                try {
                    const id = document.getElementById('edit-id').value;
                    const docData = {
                        title: document.getElementById('edit-title').value,
                        year: parseInt(document.getElementById('edit-year').value),
                        language: document.getElementById('edit-lang').value,
                        description: document.getElementById('edit-desc').value,
                        watchUrl: document.getElementById('edit-watchUrl').value,
                        downloadUrl: document.getElementById('edit-downloadUrl').value,
                        status: document.getElementById('edit-status').value,
                        posterUrl: document.getElementById('edit-posterUrl').value,
                        trendingScore: parseInt(document.getElementById('edit-trendingScore').value) || 0,
                        categorySlugs: Array.from(document.querySelectorAll('input[name="cat"]:checked')).map(c => c.value),
                        updatedAt: serverTimestamp()
                    };

                    if(id) {
                         await updateDoc(doc(db, "movies", id), docData);
                    } else {
                        docData.createdAt = serverTimestamp();
                        await addDoc(collection(db, "movies"), docData);
                    }
                    ui.toggleModal('editor-modal', false);
                    utils.showToast('Movie saved successfully');
                } catch(err) {
                    console.error(err);
                    utils.showToast('Error saving movie: ' + err.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerText = 'Save Movie';
                }
            },
            deleteMovie: async (id) => {
                if(confirm("Delete permanently?")) await deleteDoc(doc(db, "movies", id));
            },
            handleUpload: async (input, targetId, statusId) => {
                const file = input.files[0];
                if (!file) return;
                
                const status = document.getElementById(statusId);
                if(status) status.innerText = "Uploading...";
                
                try {
                    // NOTE: If this fails, user must ensure backend is setup or use client-side generation (not recommended for prod but ok for demo)
                    // For this Single File solution without backend, if AUTH fails, we can't upload.
                    // Assuming user has set up the endpoint as per their previous code.
                    const authRes = await fetch(IK_AUTH_ENDPOINT);
                    if (!authRes.ok) throw new Error("Auth Endpoint Failed");
                    const authData = await authRes.json();

                    const imagekit = new ImageKit({ publicKey: IK_PUBLIC_KEY, urlEndpoint: IK_URL_ENDPOINT });
                    
                    const res = await new Promise((resolve, reject) => {
                        imagekit.upload({
                            file: file,
                            fileName: utils.slugify(file.name),
                            tags: ["streamvault"],
                            token: authData.token,
                            signature: authData.signature,
                            expire: authData.expire
                        }, (err, result) => {
                            if(err) reject(err); else resolve(result);
                        });
                    });
                    
                    document.getElementById(targetId).value = res.url;
                    if(status) status.innerText = "Done!";
                } catch(e) {
                    console.error(e);
                    if(status) status.innerText = "Upload Error!";
                    alert("Upload failed. Ensure /api/imagekit-auth exists or check console.");
                }
            },
            renderSettingsForm: () => {
                const s = state.settings || DEFAULT_SETTINGS;
                // Text Fields
                ['siteName','logoUrl','heroTitle','heroSubtitle','posterStyle'].forEach(f => {
                    document.getElementById(`set-${f}`).value = s[f] || '';
                });
                
                document.getElementById('set-primaryColor').value = s.theme?.primaryColor || '#3b82f6';
                document.getElementById('set-sectionOrder').value = (s.sectionOrder || []).join(', ');
                document.getElementById('set-notifDelay').value = s.notificationDelaySeconds || 5;

                // Social
                document.getElementById('set-social-youtube').value = s.socialLinks?.youtube || '';
                document.getElementById('set-social-telegram').value = s.socialLinks?.telegram || '';
                document.getElementById('set-social-x').value = s.socialLinks?.x || '';

                // Admins
                document.getElementById('set-admins').value = (s.admins || []).join(', ');

                // Featured Movie
                const featSel = document.getElementById('set-featuredMovie');
                featSel.innerHTML = '<option value="">-- Auto (First Published) --</option>' + 
                    state.movies.filter(m => m.status === 'published').map(m => `
                        <option value="${m.id}" ${s.featuredMovieId === m.id ? 'selected' : ''}>${m.title}</option>
                    `).join('');

                // Toggles
                const togglesDiv = document.getElementById('set-toggles');
                const safeToggles = s.toggles || DEFAULT_SETTINGS.toggles;
                togglesDiv.innerHTML = Object.keys(safeToggles).map(k => `
                    <label class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300">
                        <input type="checkbox" id="toggle-${k}" ${safeToggles[k] ? 'checked' : ''} class="rounded bg-gray-200 dark:bg-gray-700 border-none text-primary">
                        <span class="capitalize">${k.replace(/([A-Z])/g, ' $1')}</span>
                    </label>
                `).join('');
            },
            saveSettings: async () => {
                const s = state.settings;
                const newToggles = {};
                if(s.toggles) {
                    Object.keys(s.toggles).forEach(k => {
                        const el = document.getElementById(`toggle-${k}`);
                        if(el) newToggles[k] = el.checked;
                    });
                }

                const adminsArr = document.getElementById('set-admins').value.split(',').map(e => e.trim().toLowerCase()).filter(e => e);
                // Ensure bootstrap admin is always there
                if (!adminsArr.includes(BOOTSTRAP_ADMIN_EMAIL.toLowerCase())) {
                    adminsArr.push(BOOTSTRAP_ADMIN_EMAIL.toLowerCase());
                }

                const updateData = {
                    siteName: document.getElementById('set-siteName').value,
                    logoUrl: document.getElementById('set-logoUrl').value,
                    heroTitle: document.getElementById('set-heroTitle').value,
                    heroSubtitle: document.getElementById('set-heroSubtitle').value,
                    featuredMovieId: document.getElementById('set-featuredMovie').value,
                    posterStyle: document.getElementById('set-posterStyle').value,
                    sectionOrder: document.getElementById('set-sectionOrder').value.split(',').map(x => x.trim()),
                    notificationDelaySeconds: parseInt(document.getElementById('set-notifDelay').value) || 5,
                    socialLinks: {
                        youtube: document.getElementById('set-social-youtube').value,
                        telegram: document.getElementById('set-social-telegram').value,
                        x: document.getElementById('set-social-x').value,
                    },
                    admins: adminsArr,
                    theme: { ...s.theme, primaryColor: document.getElementById('set-primaryColor').value },
                    toggles: newToggles
                };

                await setDoc(doc(db, "settings", "global"), updateData, {merge: true});
                utils.showToast("Settings Updated. Reloading...");
                setTimeout(() => window.location.reload(), 1500);
            },
            // Categories
            renderCategoriesList: () => {
                document.getElementById('admin-categories-list').innerHTML = state.categories.map(cat => `
                    <div class="flex items-center justify-between bg-white dark:bg-gray-800 p-3 rounded border border-gray-200 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center gap-3">
                            <span class="text-gray-900 dark:text-white font-bold">${cat.order || 0}</span>
                            <span class="text-gray-700 dark:text-gray-300">${cat.name}</span>
                            <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 rounded ${cat.enabled?'text-green-600':'text-red-500'}">${cat.enabled?'On':'Off'}</span>
                        </div>
                        <div class="gap-2 flex">
                            <button onclick="admin.moveCat('${cat.id}', -1)" class="text-gray-400 hover:text-gray-900 dark:hover:text-white">â†‘</button>
                            <button onclick="admin.moveCat('${cat.id}', 1)" class="text-gray-400 hover:text-gray-900 dark:hover:text-white">â†“</button>
                            <button onclick="admin.toggleCat('${cat.id}', ${!cat.enabled})" class="text-blue-500 text-xs">Toggle</button>
                            <button onclick="admin.deleteCat('${cat.id}')" class="text-red-500 text-xs">Del</button>
                        </div>
                    </div>
                `).join('');
            },
            addCategory: async () => {
                const name = prompt("Category Name:");
                if(!name) return;
                await addDoc(collection(db, "categories"), {
                    name, slug: utils.slugify(name), enabled: true, order: state.categories.length + 1
                });
            },
            moveCat: async (id, dir) => {
                const idx = state.categories.findIndex(c => c.id === id);
                if (idx < 0) return;
                const targetIdx = idx + dir;
                if (targetIdx < 0 || targetIdx >= state.categories.length) return;
                const c1 = state.categories[idx];
                const c2 = state.categories[targetIdx];
                await updateDoc(doc(db, "categories", c1.id), { order: c2.order });
                await updateDoc(doc(db, "categories", c2.id), { order: c1.order });
            },
            toggleCat: async (id, val) => updateDoc(doc(db, "categories", id), { enabled: val }),
            deleteCat: async (id) => { if(confirm("Del?")) deleteDoc(doc(db, "categories", id)); },

            // Notifications
            renderNotifList: () => {
                document.getElementById('admin-notif-list').innerHTML = state.notifications.map(n => `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded border border-gray-200 dark:border-gray-700 flex justify-between items-center shadow-sm">
                        <div>
                            <div class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                ${n.title}
                                <span class="text-xs px-2 rounded ${n.enabled?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${n.enabled?'Active':'Inactive'}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Priority: ${n.priority || 0} | Max Views: ${n.maxShows}</div>
                        </div>
                        <div>
                            <button onclick="admin.openNotifEditor('${n.id}')" class="text-blue-500 mr-3">Edit</button>
                            <button onclick="admin.deleteNotif('${n.id}')" class="text-red-500">Del</button>
                        </div>
                    </div>
                `).join('');
            },
            openNotifEditor: (id) => {
                document.getElementById('notif-form').reset();
                document.getElementById('notif-id').value = id || '';
                document.getElementById('notif-editor-title').innerText = id ? "Edit" : "Create";
                document.getElementById('upload-status-notif').innerText = '';
                
                if (id) {
                    const n = state.notifications.find(x => x.id === id);
                    if(n) {
                        document.getElementById('notif-edit-title').value = n.title;
                        document.getElementById('notif-edit-message').value = n.message;
                        document.getElementById('notif-edit-imageUrl').value = n.imageUrl || '';
                        document.getElementById('notif-edit-linkUrl').value = n.linkUrl || '';
                        document.getElementById('notif-edit-priority').value = n.priority || 0;
                        document.getElementById('notif-edit-maxShows').value = n.maxShows || 1;
                        document.getElementById('notif-edit-enabled').checked = n.enabled;
                    }
                }
                ui.toggleModal('notif-editor-modal', true);
            },
            deleteNotif: async (id) => { if(confirm("Del?")) deleteDoc(doc(db, "notifications", id)); }
        };

        // EVENT HANDLERS
        document.getElementById('auth-form').addEventListener('submit', authManager.handleAuth);
        document.getElementById('movie-form').addEventListener('submit', admin.handleMovieSave);
        document.getElementById('notif-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('notif-id').value;
            const docData = {
                title: document.getElementById('notif-edit-title').value,
                message: document.getElementById('notif-edit-message').value,
                imageUrl: document.getElementById('notif-edit-imageUrl').value,
                linkUrl: document.getElementById('notif-edit-linkUrl').value,
                priority: parseInt(document.getElementById('notif-edit-priority').value) || 0,
                maxShows: parseInt(document.getElementById('notif-edit-maxShows').value) || 1,
                enabled: document.getElementById('notif-edit-enabled').checked,
                updatedAt: serverTimestamp()
            };
            if(id) await updateDoc(doc(db, "notifications", id), docData);
            else { docData.createdAt = serverTimestamp(); await addDoc(collection(db, "notifications"), docData); }
            ui.toggleModal('notif-editor-modal', false);
        });
        
        // Theme Toggle
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            document.getElementById('theme-icon').innerText = isDark ? 'ðŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        // Set initial icon
        document.getElementById('theme-icon').innerText = document.documentElement.classList.contains('dark') ? 'ðŸŒ™' : 'â˜€ï¸';

        // Filter Inputs
        ['global-search', 'filter-lang', 'filter-year'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                if(id === 'global-search') state.filter = e.target.value;
                if(id === 'filter-lang') state.filterLang = e.target.value;
                if(id === 'filter-year') state.filterYear = e.target.value;
                ui.renderHome();
            });
            // Mobile search sync
            if(id === 'global-search') {
                document.getElementById('mobile-search').addEventListener('input', (e) => {
                    state.filter = e.target.value;
                    ui.renderHome();
                });
            }
        });

        // GLOBAL EXPORTS
        window.ui = ui;
        window.authManager = authManager;
        window.admin = admin;
        window.router = {
            navigate: (path) => {
                if (path === 'admin') {
                    if (state.isAdmin) {
                        document.getElementById('admin-panel').classList.remove('hidden');
                        admin.switchTab('movies');
                    }
                } else if (path === 'home') {
                    document.getElementById('admin-panel').classList.add('hidden');
                }
            }
        };

        // INIT AUTH
        onAuthStateChanged(auth, (u) => {
            state.user = u;
            data.init();
        });
    </script>
</body>
</html>
